# 微信

## 微信小程序分包机制

- 某些情况下，需要将小程序划分成不同的子包，在构建时打包成不同的分包，用户在使用时按需进行加载
- 通过在 app.json subpackages 字段声明项目分包结构
- 在构建小程序分包项目时，构建会输出一个或多个分包。每个使用分包小程序必定含有一个主包。所谓的主包，即放置默认启动页面/TabBar 页面，以及一些所有分包都需用到公共资源/JS 脚本；而分包则是根据开发者的配置进行划分
- 在小程序启动时，默认会下载主包并启动主包内页面，当用户进入分包内某个页面时，客户端会把对应分包下载下来，下载完成后再进行展示。目前小程序分包大小有以下限制：
  - 整个小程序所有分包大小不超过 20M
  - 单个分包/主包大小不能超过 2M
- 对小程序进行分包，可以优化小程序首次启动的下载时间，以及在多团队共同开发时可以更好的解耦协作

## 什么是 wxs

- 小程序的一套脚本语言

## 公众号用户授权流程

### 1.用户同意授权，获取 code

- 在后台配置合法域名，页面需运行在合法域名下
- 引导关注者打开微信授权页面
- 页面链接会通过 url 传递一些参数 appid、redirect_uri、response_type 等跳回应用

### 2.通过 code 换取网页授权 access_token

- 把 code 传给后端
- 后端调微信接口消费 code，获得网页授权 access_token（可选择缓存） 和 openid
- 请求微信用户信息接口，响应给前端

## 接入 js-sdk 流程

- 在后台配置合法域名，页面需运行在合法域名下
- 前端引入微信 jssdk 资源
- 请求后端获取 jssdk 签名参数接口
- 后端请求微信接口获取 access_token，再用 access_token 获取 jsapi_ticket
- 组装 noncestr、jsapi_ticket、timestamp、url，进行 sha1 签名得到 signature
- 把计算结果响应给前端
- 前端调用 wx.config 注入权限，jsApiList 配置需要调用的 jsapi
- 通过 ready 接口处理成功验证、通过 error 接口处理失败验证

## 小程序登录流程

首次登录：

- 前端调用 wx.login() 获取临时登录凭证 code，过期时间 5 分钟
- 使用 code 请求后端登录接口，通过 code 换取用户登录信息，包括用户的 openid 及本次登录的 token 等
- 前端保存 token 在缓存

再次登录：

- 获取缓存中的 token
- 如果缓存中存在 token，调用 wx.checkSession() 判断微信登录态是否过期，调用后端相关接口检查 token 是否过期
- 如有其中之一过期，则重新走登录流程

## 性能优化

- 使用分包
- 避免在代码包中包含或在 wxss 中使用 base64 内联过多、过大的图片等资源文件。这类文件应尽可能部署到 CDN，并使用 url 引入
- 启动过程中减少同步 api 的调用，会阻塞当前 js 线程
- 避免启动过程进行复杂运算
