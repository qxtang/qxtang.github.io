# HTTPS

- HTTP + SSL(TLS) = HTTPS
- 是以安全为目的设计，http 明文传输不安全
- 网景公司（Netscape）设置了 SSL 协议来对 http 协议传输的数据包进行加密处理
- TLS(Transport Layer Security) 是 SSL(Secure Socket Layer) 的后续版本
- 需要 CA 证书，有成本
- 默认端口号 443

![](../resource/HTTPS-加解密流程.png 'HTTPS 加解密流程')

## 对称加密

- 常见的有 AES 算法
- 加密与解密用的是同样的一个密钥
- 效率高
- 密钥越大，加密越强，但加密与解密的过程越慢
- 通常使用相对较小的密钥，一般小于 256 bit

缺点：

- 不安全，在发送密钥的过程中，密钥有很大的风险会被黑客们拦截
- 存储成本：每一个客户要生成一个不同的 key

解决：

- 通常的做法是将对称加密的密钥进行非对称加密，然后传送给需要它的人

## 非对称加密

- 常用的非对称加密算法是 RSA 算法
- 使用了一对密钥，公钥 和 私钥，公钥进行加密，私钥用于解密
- 私钥只能由一方安全保管，不能外泄，公钥可以发给任何请求它的人
- 发送前，发送方先索要接受方公钥，发送方得到公钥后用其加密发送内容，接收方使用私钥解密内容
- 不需要将私钥通过网络发送出去，因此安全性大大提高

缺点：

- RSA 的运算速度非常慢（而对称加密的 AES 的加密速度比较快），效率低，性能问题

## 对称与非对称结合（混合加密）

在通信刚开始的时候使用非对称加密进行一系列认证，后续通信使用对称加密：

- 接收方生成：非对称公钥和私钥
- 发送方向接收方索要非对称公钥
- 发送方生成：一个临时的对称加密密钥，往往是生成一个随机数
- 发送方将对称密钥使用非对称公钥进行加密，然后发送
- 接收方使用非对称私钥进行解密得到对称密钥
- 然后双方可以使用对称加密来进行沟通

## 中间人攻击（伪造非对称公钥）

- 针对混合加密第一步，中间人可以伪造非对称公钥
- 黑客事先设好自己的非对称公钥和私钥
- 当黑客截获了发送方向接收方索取非对称公钥的消息，就把自己的非对称公钥发给发送方，同时也把截到的发送方的消息，继续发给接收方
- 接收方收到索取公钥的请求，将公钥发送回并附带了一条信息，黑客截获了这个公钥之后，只将信息和黑客的公钥发给发送方，接收方的公钥黑客自己保留
- 之后发送方就用了黑客的非对称公钥去加密自己的消息发给接收方，被黑客截获，黑客再用自己的非对称私钥去解密
- 甚至可以随意篡改消息内容，用之前保留的接收方的公钥去加密消息，再发给接收方

![](../resource/中间人攻击.png '中间人攻击')

### 解决

- 第三方公证机构（CA）介入
- 接收方使用自己的公钥去 CA 开证明，CA 将接收方公钥、必要信息等包装成一个证书，能够证明接收方身份
- 收到这个证书的发送方，就能确认这是接收方的公钥

## 防止证书在传输过程中被黑客篡改

**服务器在发送浏览器的公钥中加入 CA 证书，浏览器可以验证 CA 证书的有效性**

- 接收方先把自己的公钥和必要信息用一个 hash 算法生成一个 `数字摘要`

  > hash 算法特性：只要信息内容有一点的更改，重新使用该算法生成的 `数字摘要` 内容将会产生巨变

- CA 有自己的私钥和公钥
- CA 使用自己的私钥对该 `数字摘要` 进行加密，生成 `数字签名`
- 把接收方的必要信息和 `数字签名` 合并，得到 `数字证书`
- 发送方向接收方索要公钥时，接收方就把证书发给发送方
- 发送方收到证书后，先用从证书内拿到的 `hash算法` 对接收方的原始信息生成新的 `数字摘要`
- 再用 CA 的公钥对 `数字签名` 进行解密，也生成一个 `数字摘要`，如果接收方的信息被篡改了，hash 生成的摘要将会与 CA 公钥解密得到的摘要有巨大的不同
- 由此可判定传过来的公钥等其他信息是否被中途篡改过

## 如何验证证书的合法性

- 首先浏览器读取证书中的证书所有者、有效期等信息进行校验，校验证书的网站域名是否与证书颁发的域名一致，校验证书是否在有效期内；
- 浏览器开始查找操作系统中已内置的受新人的证书发布机构 CA，与服务器发来的证书中的颁发者 CA 比对，用于校验证书是否为合法机构颁发；
- 如果找不到，浏览器就会报错，说明浏览器发来的证书是不可信任的；
- 如果找到，那么浏览器就会从操作系统中取出颁发者 CA 的公钥（多数浏览器开发商发布版本时，会实现在内部植入常用认证机关的公开密钥），然后对服务器发来的证书里面的签名进行解密；
- 浏览器使用相同的 hash 算法计算出服务器发来的证书的 hash 值，将这个计算的 hash 值与证书中签名做对比；
- 对比结果一致，则证明服务器发来的证书合法，没有被冒充；

## SSL/TLS

- 处于会话层
- TLS(Transport Layer Security) 是 SSL(Secure Socket Layer) 的后续版本，用于在互联网两台计算机之间用于身份验证和加密的一种协议
- 通常情况下，HTTP 会先直接和 TCP 进行通信， 使用 SSL 后，则会先和 SSL 进行通信，然后再由 SSL 和 TCP 进行通信，HTTPS 就是身披了一层 SSL 的 HTTP
- SSL 是一个独立的协议，不只有 HTTP 可以使用，其他应用层协议也可以使用，比如 SMTP(电子邮件协议)、Telnet(远程登录协议) 等都可以使用

### TLS 的结构

- **密钥交换算法 - 签名算法 - 对称加密算法 - 摘要算法** 组成的一个密码串

```yaml
ECDHE-ECDSA-AES256-GCM-SHA384
# 使用 ECDHE 进行密钥交换，使用 ECDSA 进行签名和认证，然后使用 AES 作为对称加密算法，密钥的长度是 256 位，使用 GCM 作为分组模式，最后使用 SHA384 作为摘要算法
```
