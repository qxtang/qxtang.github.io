<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qxtang.github.io - Babel</title>

  <!-- styles -->
  <link rel="stylesheet" href="/resource/lib/github-markdown.min.css" />
  <link rel="stylesheet" href="/resource/style.css" />
  <link rel="stylesheet" href="/resource/lib/highlight.default.min.css" />
  <link rel="stylesheet" href="/resource/lib/viewerjs-1.10.5/viewer.min.css" />

  <!-- scripts -->
  <script src="/resource/lib/jquery.min.js"></script>

  <!-- PWA support -->
  <link rel="manifest" href="/manifest.json" />
  <link rel="shortcut icon" type="image/x-icon" href="/resource/favicon.ico" />
  <link rel="bookmark" type="image/x-icon" href="/resource/favicon.ico" />
  <link rel="apple-touch-icon" href="/resource/favicon.ico" />

  <!-- version：1.3.5 -->
  <!-- build time：3/15/2023, 4:45:34 PM -->

  <script>
    window.root = '';

    // 提前把搜索数据库载入内存
    fetch(`${window.root}/dir_tree.json`)
            .then(function (res) {
              return res.json();
            })
            .then(function (res) {
              window.__doc_builder_dir_tree__ = res;
            });
  </script>
</head>

  <body>
    <ul class="menu expand" id="menu">
      <div class="loading">
        <span>加载中...</span>
      </div>
      <div class="search_bar" id="search_bar">
        <input type="text" placeholder="search..." />
        <img
          class="clear"
          id="clear"
          src="/resource/icons/circle-xmark.svg"
          alt=""
        />
        <div class="search_result" id="search_result"></div>
      </div>
      
            <ul class="parent expand">
              <li id="cfc6762313c8fadde407c043154409f7" data-href="" class="dir" title="最佳实践">
                <span>最佳实践</span>
                <div class="triangle"></div>
              </li>
              
          <li id="90c722fcc7f93ea31011ef4abc7f384d" class="children" title="Javascript">
            <a href="/90c722fcc7f93ea31011ef4abc7f384d.html">Javascript</a>
          </li>
        
          <li id="38f7be06c8c5c4d4d37ea6cadecfc7fe" class="children" title="React">
            <a href="/38f7be06c8c5c4d4d37ea6cadecfc7fe.html">React</a>
          </li>
        
          <li id="d02c013ecd23b0f2469dc30db74d4108" class="children" title="git 实践">
            <a href="/d02c013ecd23b0f2469dc30db74d4108.html">git 实践</a>
          </li>
        
          <li id="e7542d604b34ce539d8b7baa7df7746b" class="children" title="通用工程实践">
            <a href="/e7542d604b34ce539d8b7baa7df7746b.html">通用工程实践</a>
          </li>
        
            </ul>
          
          <li id="e3db49d633625ac1552e7dca23fb879e" class="children" title="AST抽象语法树">
            <a href="/e3db49d633625ac1552e7dca23fb879e.html">AST抽象语法树</a>
          </li>
        
          <li id="fcd42fc1afe1592eb752d49cc60a4157" class="children" title="Babel">
            <a href="/fcd42fc1afe1592eb752d49cc60a4157.html">Babel</a>
          </li>
        
          <li id="14168fa339500eb086fd9bc8c3f8933c" class="children" title="Nginx 笔记">
            <a href="/14168fa339500eb086fd9bc8c3f8933c.html">Nginx 笔记</a>
          </li>
        
      <li id="index.md" class="children about">
        <a href="/">关于</a>
      </li>
    </ul>
    <div class="drager" id="drager">
      <div class="switcher btn" id="switcher" title="展开或收起"></div>
      <div class="expand-all btn" id="expand-all" title="展开所有"></div>
      <div class="collapse-all btn" id="collapse-all" title="收起所有"></div>
    </div>
    <div class="mobile_menu" id="mobile_menu">
      <img src="/resource/icons/bars.svg" alt="" />
    </div>
    <div class="content markdown-body">
      <h1 id="babel" tabindex="-1"><a class="header-anchor" href="#babel">Babel</a></h1>
<h2 id="%E6%A6%82%E5%BF%B5" tabindex="-1"><a class="header-anchor" href="#%E6%A6%82%E5%BF%B5">概念</a></h2>
<ul>
<li>一个 JavaScript 翻译器</li>
<li>将 ECMAScript 2015+ 语法编写的代码转换为向后兼容的 JavaScript 语法，以便能够运行在各种环境中</li>
<li>通过 Polyfill 方式在目标环境中添加缺失的特性 （通过引入第三方 polyfill 模块，例如 core-js）</li>
</ul>
<h2 id="%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86" tabindex="-1"><a class="header-anchor" href="#%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">基本工作原理</a></h2>
<ul>
<li>
<p>第 1 步 解析（Parse）<br>
通过解析器 babylon 将代码解析成抽象语法树，包括词法分析和语法分析，词法分析主要把字符流源代码（Char Stream）转换成令牌流（ Token Stream），语法分析主要是将令牌流转换成抽象语法树</p>
</li>
<li>
<p>第 2 步 转换（TransForm）<br>
通过 babel-traverse plugin 对抽象语法树进行深度优先遍历，遇到需要转换的，就直接在 AST 对象上对节点进行添加、更新及移除操作，比如遇到箭头函数，就转换成普通函数，最后得到新的 AST 树</p>
</li>
<li>
<p>第 3 步 生成（Generate）<br>
通过 babel-generator 将 AST 树生成 es5 代码，同时也能创建 Source Map 映射</p>
</li>
</ul>
<figure><img src="./resource/babel1.png" alt=""></figure>
<figure><img src="./resource/babel2.png" alt=""></figure>
<h2 id="%E9%85%8D%E7%BD%AE" tabindex="-1"><a class="header-anchor" href="#%E9%85%8D%E7%BD%AE">配置</a></h2>
<p>主要分为 presets 和 plugins</p>
<h3 id=".babelrc._-%E5%92%8C-babel.config._-%E5%8C%BA%E5%88%AB" tabindex="-1"><a class="header-anchor" href="#.babelrc._-%E5%92%8C-babel.config._-%E5%8C%BA%E5%88%AB">.babelrc._ 和 babel.config._ 区别</a></h3>
<ul>
<li>.babelrc._ 仅适用于项目的某个部分</li>
<li>babel.config._ 会影响整个项目中的代码，包含 node_modules 中的代码</li>
<li>推荐使用 babel.config._，Babel 自身使用的就是这种格式</li>
</ul>
<h3 id="presets" tabindex="-1"><a class="header-anchor" href="#presets">presets</a></h3>
<ul>
<li>逆序处理，从后往前，这主要是为了确保向后兼容，由于大多数用户将 &quot;es2015&quot; 放在 &quot;stage-0&quot; 之前，</li>
<li>可以是数组、对象、字符串</li>
</ul>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;presets&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">&quot;presetA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// bare string</span>
    <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;presetA&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// wrapped in array</span>
    <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;presetA&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 2nd argument is an empty options object</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 id="usebuiltins" tabindex="-1"><a class="header-anchor" href="#usebuiltins">useBuiltIns</a></h4>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;presets&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">[</span>
      <span class="hljs-string">&quot;@babel/preset-env&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;useBuiltIns&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;usage&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;debug&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;corejs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span> <span class="hljs-comment">// 建议使用 3，core-js@2 分支中已经不会再添加新特性，新特性都会添加到 core-js@3</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>babel 在转译的时候，会将源代码分成 syntax（语法） 和 api 两部分来处理，语法处理通过配置 presets，</li>
<li>babel 使用 polyfill 来处理 api，@babel/preset-env 中有一个配置选项 useBuiltIns，用来告诉 babel 如何处理 api，由于这个选项默认值为 false，即不处理 api，所以代码转译后默认没有处理 api，可以通过手动引入 polyfill，但是 polyfill 没有动态引入会增加包的体积</li>
<li>设置 useBuiltIns 的值为 &quot;entry&quot;，同时在源代码的最上方手动引入 <code>@babel/polyfill</code> 这个库（该库一共分为两部分，第一部分是 core-js，第二部分是 regenerator-runtime。其中 core-js 为其他团队开源的另一个独立项目），此时 babel 根据项目 browserslist，引入浏览器不兼容的 polyfill。需要在入口文件手动添加 <code>import '@babel/polyfill'</code>，会自动根据 browserslist 替换成浏览器不兼容的所有 polyfill</li>
<li>将 useBuiltIns 改为 &quot;usage&quot;，babel 就可以按需加载 polyfill，并且不需要手动引入 <code>@babel/polyfill</code></li>
</ul>
<h5 id="%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98" tabindex="-1"><a class="header-anchor" href="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98">存在的问题</a></h5>
<ul>
<li>polyfill 会直接在全局对象上定义方法，比如 Array.include，众所周知前端开发不鼓励污染全局变量，</li>
<li>babel 会向翻译后的<strong>每一个</strong>文件原地定义许多帮助函数，用于转义语法，比如 <code>__spreadArray</code>、<code>__generator</code>,</li>
</ul>
<h3 id="plugins" tabindex="-1"><a class="header-anchor" href="#plugins">plugins</a></h3>
<ul>
<li>本质是一个 JS 程序, 指示 Babel 如何对代码进行转换</li>
<li>排列顺序很重要</li>
<li>plugins 在 presets 之前运行</li>
<li>plugins 顺序从前往后排列，与 presets 相反</li>
</ul>
<h2 id="%E6%A0%B8%E5%BF%83%E4%B8%8E%E5%85%B6%E5%91%A8%E8%BE%B9" tabindex="-1"><a class="header-anchor" href="#%E6%A0%B8%E5%BF%83%E4%B8%8E%E5%85%B6%E5%91%A8%E8%BE%B9">核心与其周边</a></h2>
<h3 id="%40babel%2Fcore" tabindex="-1"><a class="header-anchor" href="#%40babel%2Fcore">@babel/core</a></h3>
<ul>
<li>babel 使用了微内核的架构风格，也就是说它们的核心非常小，大部分功能都是通过插件扩展实现的，@babel/core 就是这个内核，包含核心功能</li>
<li>作用：
<ul>
<li>加载和处理配置(config)</li>
<li>加载插件</li>
<li>调用 Parser 进行语法解析，生成 AST</li>
<li>调用 Traverser 遍历 AST，并使用访问者模式应用'插件'对 AST 进行转换</li>
<li>生成代码，包括 SourceMap 转换和源代码生成</li>
</ul>
</li>
</ul>
<h3 id="%40babel%2Fcli" tabindex="-1"><a class="header-anchor" href="#%40babel%2Fcli">@babel/cli</a></h3>
<p>命令行工具</p>
<h3 id="%40babel%2Fplugin-transform-runtime%E3%80%81%40babel%2Fruntime" tabindex="-1"><a class="header-anchor" href="#%40babel%2Fplugin-transform-runtime%E3%80%81%40babel%2Fruntime">@babel/plugin-transform-runtime、@babel/runtime</a></h3>
<ul>
<li>这个插件就是为了解决 useBuiltIns polyfill 污染全局的问题和每一个文件都有辅助函数问题，</li>
<li>将 babel 转译时添加到文件中的内联辅助函数统一隔离到 babel-runtime 提供的 helper 模块中</li>
<li>编译时，直接从 helper 模块加载，不在每个文件中重复的定义辅助函数，从而减少包的尺寸</li>
<li>其中 <code>@babel/plugin-transform-runtime</code> 的作用是转译代码，转译后的代码中可能会引入 <code>@babel/runtime-corejs3</code> 里面的模块。</li>
<li>前者运行在编译时，后者运行在运行时。类似 polyfill，后者需要被打包到最终产物里在浏览器中运行</li>
<li>@babel/plugin-transform-runtime 通常仅在开发时使用，但是运行时最终代码需要依赖 @babel/runtime，所以 @babel/runtime 必须要作为生产依赖被安装</li>
<li>typescript 的 importHelpers 配置和 tslib 也是类似的原理</li>
</ul>
<p>安装：</p>
<pre><code class="language-sh">$ yarn add @babel/plugin-transform-runtime -D
$ yarn add @babel/runtime-corejs3
</code></pre>
<p>修改配置如下：</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;presets&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">[</span>
      <span class="hljs-string">&quot;@babel/preset-env&quot;</span>
      <span class="hljs-comment">// 移除，否则和下面重复了</span>
      <span class="hljs-comment">// {</span>
      <span class="hljs-comment">//   &quot;useBuiltIns&quot;: &quot;usage&quot;,</span>
      <span class="hljs-comment">//   &quot;debug&quot;: true</span>
      <span class="hljs-comment">// }</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;plugins&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">[</span>
      <span class="hljs-string">&quot;@babel/plugin-transform-runtime&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;corejs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span> <span class="hljs-comment">// 指定 runtime-corejs 的版本，目前有 2 3 两个版本</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>引入了这个插件后：</p>
<ul>
<li>api 从之前的直接修改原型改为了从一个统一的模块中引入，避免了对全局变量及其原型的污染</li>
<li>helpers 从之前的原地定义改为了从一个统一的模块中引入，使得打包的结果中每个 helper 只会存在一个</li>
</ul>
<h3 id="%40babel%2Fparser" tabindex="-1"><a class="header-anchor" href="#%40babel%2Fparser">@babel/parser</a></h3>
<ul>
<li>将源代码解析为 AST</li>
<li>已经内置支持很多语法. 例如 JSX、Typescript、Flow、以及最新的 ECMAScript 规范</li>
</ul>
<h3 id="%40babel%2Ftraverse" tabindex="-1"><a class="header-anchor" href="#%40babel%2Ftraverse">@babel/traverse</a></h3>
<ul>
<li>实现了访问者模式，对 AST 进行遍历，转换插件会通过它获取感兴趣的 AST 节点，对节点继续操作</li>
</ul>
<h3 id="%40babel%2Fgenerator" tabindex="-1"><a class="header-anchor" href="#%40babel%2Fgenerator">@babel/generator</a></h3>
<ul>
<li>将 AST 转换为源代码，支持 SourceMap</li>
</ul>
<h3 id="%40babel%2Fpreset-env" tabindex="-1"><a class="header-anchor" href="#%40babel%2Fpreset-env">@babel/preset-env</a></h3>
<ul>
<li>语法转换插件的集合</li>
<li>可以根据目标浏览器运行环境配置（browserslist、targets），将 ES2015+ 的语法转换为 es5 语法，不需要一个个语法插件去安装（比如@babel/plugin-transform-arrow-functions）</li>
</ul>
<h3 id="core.js" tabindex="-1"><a class="header-anchor" href="#core.js">core.js</a></h3>
<ul>
<li>新 api 集合</li>
</ul>
<h3 id="%40babel%2Fpolyfill" tabindex="-1"><a class="header-anchor" href="#%40babel%2Fpolyfill">@babel/polyfill</a></h3>
<ul>
<li>@babel/polyfill 融合了 core-js 和 regenerator-runtime，因此 babel-polyfill 本质就是 corejs</li>
<li>引入 @bable/polyfill 就相当于在代码中引入下面两个库<pre><code class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;core-js/stable&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;regenerator-runtime/runtime&#x27;</span>;
</code></pre>
</li>
<li>官方提示已经 deprecated，推荐使用 core-js@3 + @babel/preset-env 即可<pre><code class="language-txt">🚨 As of Babel 7.4.0, this package has been deprecated in favor of directly including core-js/stable (to polyfill ECMAScript features) and regenerator-runtime/runtime (needed to use transpiled generator functions)
</code></pre>
</li>
</ul>
<h3 id="regenerator-runtime" tabindex="-1"><a class="header-anchor" href="#regenerator-runtime">regenerator-runtime</a></h3>
<ul>
<li>生成器函数、async、await 函数经 babel 编译后，regenerator-runtime 模块用于提供功能实现，运行时依赖，需要打包进产物</li>
</ul>

      
        <div class="btt withToc" id="btt"></div>
      
    </div>
    
    <div class="table-of-contents"><ul><li title="Babel"><a href="#babel" data-anchor="#babel">Babel</a><ul><li title="概念"><a href="#%E6%A6%82%E5%BF%B5" data-anchor="#%E6%A6%82%E5%BF%B5">概念</a></li><li title="基本工作原理"><a href="#%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86" data-anchor="#%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">基本工作原理</a></li><li title="配置"><a href="#%E9%85%8D%E7%BD%AE" data-anchor="#%E9%85%8D%E7%BD%AE">配置</a><ul><li title=".babelrc._ 和 babel.config._ 区别"><a href="#.babelrc._-%E5%92%8C-babel.config._-%E5%8C%BA%E5%88%AB" data-anchor="#.babelrc._-%E5%92%8C-babel.config._-%E5%8C%BA%E5%88%AB">.babelrc._ 和 babel.config._ 区别</a></li><li title="presets"><a href="#presets" data-anchor="#presets">presets</a><ul><li title="useBuiltIns"><a href="#usebuiltins" data-anchor="#usebuiltins">useBuiltIns</a><ul><li title="存在的问题"><a href="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98" data-anchor="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98">存在的问题</a></li></ul></li></ul></li><li title="plugins"><a href="#plugins" data-anchor="#plugins">plugins</a></li></ul></li><li title="核心与其周边"><a href="#%E6%A0%B8%E5%BF%83%E4%B8%8E%E5%85%B6%E5%91%A8%E8%BE%B9" data-anchor="#%E6%A0%B8%E5%BF%83%E4%B8%8E%E5%85%B6%E5%91%A8%E8%BE%B9">核心与其周边</a><ul><li title="@babel/core"><a href="#%40babel%2Fcore" data-anchor="#%40babel%2Fcore">@babel/core</a></li><li title="@babel/cli"><a href="#%40babel%2Fcli" data-anchor="#%40babel%2Fcli">@babel/cli</a></li><li title="@babel/plugin-transform-runtime、@babel/runtime"><a href="#%40babel%2Fplugin-transform-runtime%E3%80%81%40babel%2Fruntime" data-anchor="#%40babel%2Fplugin-transform-runtime%E3%80%81%40babel%2Fruntime">@babel/plugin-transform-runtime、@babel/runtime</a></li><li title="@babel/parser"><a href="#%40babel%2Fparser" data-anchor="#%40babel%2Fparser">@babel/parser</a></li><li title="@babel/traverse"><a href="#%40babel%2Ftraverse" data-anchor="#%40babel%2Ftraverse">@babel/traverse</a></li><li title="@babel/generator"><a href="#%40babel%2Fgenerator" data-anchor="#%40babel%2Fgenerator">@babel/generator</a></li><li title="@babel/preset-env"><a href="#%40babel%2Fpreset-env" data-anchor="#%40babel%2Fpreset-env">@babel/preset-env</a></li><li title="core.js"><a href="#core.js" data-anchor="#core.js">core.js</a></li><li title="@babel/polyfill"><a href="#%40babel%2Fpolyfill" data-anchor="#%40babel%2Fpolyfill">@babel/polyfill</a></li><li title="regenerator-runtime"><a href="#regenerator-runtime" data-anchor="#regenerator-runtime">regenerator-runtime</a></li></ul></li></ul></li></ul></div>
    

    <!-- bottom scripts -->
    <script src="/resource/lib/mark.js-8.11.1/jquery.mark.min.js"></script>
    <script src="/resource/lib/viewerjs-1.10.5/viewer.min.js"></script>
    <script src="/resource/lib/jquery-viewer-1.0.1/jquery-viewer.min.js"></script>
    <script src="/resource/script.js"></script>
  </body>
</html>
