# 浏览器架构

以 chrome 为例

## 主要组成

- ⽤户界⾯：地址栏、前进/后退按钮、书签菜单等
- 浏览器引擎：在⽤户界⾯和渲染引擎之间传送指令
- 渲染引擎：负责显示请求的内容
- ⽹络：⽤于⽹络调⽤
- JavaScript 解释器
- 数据存储

## 各个进程以及负责的工作

chrome 采用多进程架构

### Browser（主进程）

- 浏览器界面显示，用户交互，前进、后退、收藏
- 前进和后退按钮
- 控制看不见的部分：网络请求、文件读写
- 页面的创建、销毁

### Plugin（插件进程）

- 控制网页使用的所有插件，例如 flash 插件
- 每种类型的插件对应一个进程，仅当使用该插件时才创建

### GPU

- 3D 绘制，负责独立于其它进程的 GPU 任务。它之所以被独立为一个进程是因为它要处理来自于不同 tab 的渲染请求并把它在同一个界面上画出来

### Renderer（渲染进程）（最重要）

- 每个 Tab 页对应一个
- 渲染进程，即浏览器内核
- 这就是主要与前端开发打交道的进程，负责页面渲染，脚本执行，事件处理等
- 负责 tab 内和网页展示相关的所有工作。Chrome 会尽可能为每一个 tab 甚至是页面里面的每一个 iframe 都分配一个单独的渲染进程

## 渲染进程

渲染进程包含几大类子线程：

### GUI 渲染线程

- 负责渲染页面，布局和绘制
- 页面需要重绘和回流时，该线程就会执行
- 与 js 引擎线程互斥，防止渲染结果不可预期

### JS 引擎线程

- 负责处理解析和执行 javascript 脚本程序
- 只有一个 JS 引擎线程（单线程）
- 与 GUI 渲染线程互斥，防止渲染结果不可预期

### 事件触发线程

- 用来控制事件循环
- 当事件满足触发条件时，将事件放入到 JS 引擎所在的执行队列中

### 定时器线程

- setInterval 与 setTimeout 所在的线程
- 定时任务并不是由 JS 引擎计时的，是由定时触发线程来计时的
- 计时完毕后，通知事件触发线程

### 异步网络请求线程

- 浏览器有一个单独的线程用于处理 AJAX 请求
- 当请求完成时，若有回调函数，通知事件触发线程

> 其中 GUI 线程和 JS 引擎线程是互斥的，  
> 由于 JavaScript 是可操纵 DOM 的，如果在修改这些元素属性同时渲染界面（即 JavaScript 线程和 UI 线程同时运行），那么渲染线程前后获得的元素数据就可能不一致

## 一个 tab 一个渲染进程的优缺点

- 优点：提供安全性和沙盒性，当其中一个 tab 的崩溃时，你可以随时关闭这个 tab 并且其他 tab 不受到影响
- 缺点：内存消耗大

## 网站隔离功能

- 会为网站内不同站点的 iframe 分配一个独立的渲染进程
- 由来：如果一个 tab 只有一个进程的话不同站点的 iframe 都会跑在这个进程里面，这也意味着它们会共享内存，这就有可能会破坏同源策略

## 常见浏览器内核

- IE：Trident 内核，也是俗称的 IE 内核
- Chrome：以前是 Webkit 内核，现在是 Blink 内核
- Firefox：Gecko 内核
- 苹果 Safari：Webkit 内核

## 参考

- https://juejin.cn/post/6844904046411644941
- https://zhuanlan.zhihu.com/p/149063367
